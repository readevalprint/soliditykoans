<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Main</title>
    <script src="lib/soljson.js"></script>
    <script src="elm.js"></script>
    <script src="bundle.js"></script>
  </head>

  <body>
    <div id="elm"></div>
    <script>
      var app = Elm.Main.init({
        node: document.getElementById('elm')
      });

      app.ports.toJs.subscribe(console.log)

      input = {
        // Required: Source code language, such as "Solidity", "Vyper", "lll", "assembly", etc.
        language: "Solidity",
        // Required
        sources:
        {
          // The keys here are the "global" names of the source files,
          // imports can use other files via remappings (see below).
          "foo.sol": {"content": `
            pragma solidity ^0.5.0;

            contract Foo {
              uint public num;
              event Log(
              uint _value
              );
              constructor() public payable {
                num = block.timestamp;
                emit Log(num);
              }
              function deposit(uint _num) public payable returns(uint) {
                emit Log(num);
                uint old_num = num;
                num = _num;
                return old_num;
              }
            }`
          },
          "bar.sol": {"content": `
            pragma solidity ^0.5.0;

            contract Bar {
              uint public num;
              event Log(
              uint _value
              );
              constructor() public payable {
                num = block.timestamp;
                emit Log(num);
              }
              function deposit(uint _num) public payable returns(uint) {
                emit Log(num);
                uint old_num = num;
                num = _num;
                return old_num;
              }
            }`
            //"pragma solidity ^0.5.0;contract Hell {    uint last_timestamp; constructor() public {        last_timestamp = block.timestamp;           }   }"}
        }
      },
      settings: {
        metadata: {
          // Use only literal content and not URLs (false by default)
          useLiteralContent: true
        },
        outputSelection: {
          // Enable the metadata and bytecode outputs of every single contract.
          "*": {
            "*": [ "evm.bytecode", "abi", "devdoc", "userdoc"]
          }
        }

      }

    }
    out = solc.compile(JSON.stringify(input), console.log)
    solc_out = JSON.parse(out)
    contractBytecode = solc_out.contracts["foo.sol"]['Foo'].evm.bytecode.object
    contractABI = solc_out.contracts["foo.sol"]['Foo'].abi


    // web3.setProvider(new sim.Provider())
    // eth = new Eth(new sim.Provider())
    web3.eth.getAccounts().then((accounts) => {web3.eth.defaultAccount = accounts[0]

      contract1 = new web3.eth.Contract(contractABI)


      return contract1.deploy({data: contractBytecode}).send({from: web3.eth.defaultAccount}).then(function(newContractInstance){
        console.log(newContractInstance.options.address) // instance with the new contract address
        contract1.options.address = newContractInstance.options.address



        return contract1.methods.deposit(123).send({from: web3.eth.defaultAccount}).on('receipt', function(receipt){
          // receipt example
          console.log(receipt)
        })
      })

    })



  </script>
</body>
</html>
